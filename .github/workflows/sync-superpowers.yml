name: Sync Superpowers from Upstream

on:
  schedule:
    # Run weekly on Sundays at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    # Allow manual triggering

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone upstream superpowers
        run: |
          git clone --depth 1 https://github.com/obra/superpowers.git /tmp/upstream-superpowers

      - name: Get upstream version
        id: upstream
        run: |
          VERSION=$(cat /tmp/upstream-superpowers/.claude-plugin/plugin.json | jq -r '.version')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Get current version
        id: current
        run: |
          VERSION=$(cat plugins/superpowers/.claude-plugin/plugin.json | jq -r '.version')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Sync if versions differ
        if: steps.upstream.outputs.version != steps.current.outputs.version
        env:
          UPSTREAM_VERSION: ${{ steps.upstream.outputs.version }}
          CURRENT_VERSION: ${{ steps.current.outputs.version }}
        run: |
          echo "Upstream version: $UPSTREAM_VERSION"
          echo "Current version: $CURRENT_VERSION"

          # Remove old content (keep our custom files)
          rm -rf plugins/superpowers/skills
          rm -rf plugins/superpowers/agents
          rm -rf plugins/superpowers/commands
          rm -rf plugins/superpowers/hooks

          # Copy new content from upstream
          cp -r /tmp/upstream-superpowers/skills plugins/superpowers/
          cp -r /tmp/upstream-superpowers/agents plugins/superpowers/
          cp -r /tmp/upstream-superpowers/commands plugins/superpowers/
          cp -r /tmp/upstream-superpowers/hooks plugins/superpowers/

          # Update version in our plugin.json while preserving our modifications
          jq --arg version "$UPSTREAM_VERSION" '.version = $version' \
            plugins/superpowers/.claude-plugin/plugin.json > /tmp/plugin.json
          mv /tmp/plugin.json plugins/superpowers/.claude-plugin/plugin.json

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        env:
          UPSTREAM_VERSION: ${{ steps.upstream.outputs.version }}
          CURRENT_VERSION: ${{ steps.current.outputs.version }}
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update superpowers to v${{ steps.upstream.outputs.version }}"
          title: "Update superpowers to v${{ steps.upstream.outputs.version }}"
          body: |
            This PR updates the superpowers plugin from upstream.

            **Upstream:** [obra/superpowers](https://github.com/obra/superpowers)
            **Previous version:** ${{ steps.current.outputs.version }}
            **New version:** ${{ steps.upstream.outputs.version }}

            Please review the changes before merging.
          branch: sync-superpowers-${{ steps.upstream.outputs.version }}
          delete-branch: true
          labels: |
            automated
            sync
