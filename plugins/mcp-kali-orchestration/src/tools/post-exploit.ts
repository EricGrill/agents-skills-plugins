import type { Backend } from "../backends/interface.js";
import type { ToolDefinition } from "../server.js";

function createToolRunner(
  backend: Backend,
  instanceIdArg: string,
  buildCommand: (args: Record<string, unknown>) => string[],
  timeoutMs = 300000
) {
  return async (args: Record<string, unknown>) => {
    const instanceId = args[instanceIdArg] as string;
    const command = buildCommand(args);

    const result = await backend.execCommand(instanceId, command, {
      user: "root",
      timeoutMs,
    });

    return {
      content: [
        {
          type: "text" as const,
          text: JSON.stringify(
            {
              success: result.exitCode === 0,
              exit_code: result.exitCode,
              stdout: result.stdout,
              stderr: result.stderr,
            },
            null,
            2
          ),
        },
      ],
    };
  };
}

export function registerPostExploitTools(
  backend: Backend,
  tools: Map<string, ToolDefinition>
): void {
  // impacket_secretsdump - Dump secrets from Windows
  tools.set("impacket_secretsdump", {
    name: "impacket_secretsdump",
    description: "Dump NTLM hashes and secrets from Windows targets using Impacket.",
    inputSchema: {
      type: "object",
      properties: {
        instance_id: { type: "string", description: "Kali instance ID" },
        target: {
          type: "string",
          description: "Target in format domain/user:password@host or domain/user@host (for hash auth)",
        },
        hashes: {
          type: "string",
          description: "NTLM hashes for pass-the-hash (LM:NT format)",
        },
        just_dc: {
          type: "boolean",
          description: "Extract only NTDS.DIT data (for DCs)",
        },
        just_dc_ntlm: {
          type: "boolean",
          description: "Extract only NTLM hashes from NTDS.DIT",
        },
      },
      required: ["instance_id", "target"],
    },
    handler: createToolRunner(
      backend,
      "instance_id",
      (args) => {
        const cmd = ["impacket-secretsdump"];
        if (args.hashes) cmd.push("-hashes", args.hashes as string);
        if (args.just_dc) cmd.push("-just-dc");
        if (args.just_dc_ntlm) cmd.push("-just-dc-ntlm");
        cmd.push(args.target as string);
        return cmd;
      },
      600000
    ),
  });

  // impacket_psexec - Remote execution via SMB
  tools.set("impacket_psexec", {
    name: "impacket_psexec",
    description: "Execute commands on Windows targets via SMB/psexec.",
    inputSchema: {
      type: "object",
      properties: {
        instance_id: { type: "string", description: "Kali instance ID" },
        target: {
          type: "string",
          description: "Target in format domain/user:password@host",
        },
        command: { type: "string", description: "Command to execute" },
        hashes: { type: "string", description: "NTLM hashes (LM:NT format)" },
      },
      required: ["instance_id", "target"],
    },
    handler: createToolRunner(
      backend,
      "instance_id",
      (args) => {
        const cmd = ["impacket-psexec"];
        if (args.hashes) cmd.push("-hashes", args.hashes as string);
        cmd.push(args.target as string);
        if (args.command) cmd.push(args.command as string);
        return cmd;
      },
      600000
    ),
  });

  // impacket_smbexec - SMB-based execution
  tools.set("impacket_smbexec", {
    name: "impacket_smbexec",
    description: "Execute commands via SMB without uploading files.",
    inputSchema: {
      type: "object",
      properties: {
        instance_id: { type: "string", description: "Kali instance ID" },
        target: { type: "string", description: "Target (domain/user:password@host)" },
        command: { type: "string", description: "Command to execute" },
        hashes: { type: "string", description: "NTLM hashes" },
      },
      required: ["instance_id", "target"],
    },
    handler: createToolRunner(backend, "instance_id", (args) => {
      const cmd = ["impacket-smbexec"];
      if (args.hashes) cmd.push("-hashes", args.hashes as string);
      cmd.push(args.target as string);
      if (args.command) cmd.push(args.command as string);
      return cmd;
    }),
  });

  // impacket_wmiexec - WMI-based execution
  tools.set("impacket_wmiexec", {
    name: "impacket_wmiexec",
    description: "Execute commands via WMI.",
    inputSchema: {
      type: "object",
      properties: {
        instance_id: { type: "string", description: "Kali instance ID" },
        target: { type: "string", description: "Target (domain/user:password@host)" },
        command: { type: "string", description: "Command to execute" },
        hashes: { type: "string", description: "NTLM hashes" },
      },
      required: ["instance_id", "target"],
    },
    handler: createToolRunner(backend, "instance_id", (args) => {
      const cmd = ["impacket-wmiexec"];
      if (args.hashes) cmd.push("-hashes", args.hashes as string);
      cmd.push(args.target as string);
      if (args.command) cmd.push(args.command as string);
      return cmd;
    }),
  });

  // evil_winrm - WinRM shell
  tools.set("evil_winrm", {
    name: "evil_winrm",
    description: "Connect to Windows Remote Management (WinRM) shell.",
    inputSchema: {
      type: "object",
      properties: {
        instance_id: { type: "string", description: "Kali instance ID" },
        target: { type: "string", description: "Target IP or hostname" },
        username: { type: "string", description: "Username" },
        password: { type: "string", description: "Password" },
        hash: { type: "string", description: "NTLM hash for pass-the-hash" },
        command: {
          type: "string",
          description: "Single command to execute (non-interactive)",
        },
      },
      required: ["instance_id", "target", "username"],
    },
    handler: createToolRunner(
      backend,
      "instance_id",
      (args) => {
        const cmd = ["evil-winrm", "-i", args.target as string, "-u", args.username as string];
        if (args.password) cmd.push("-p", args.password as string);
        if (args.hash) cmd.push("-H", args.hash as string);
        if (args.command) cmd.push("-c", args.command as string);
        return cmd;
      },
      600000
    ),
  });

  // crackmapexec_run - Network protocol attacks
  tools.set("crackmapexec_run", {
    name: "crackmapexec_run",
    description:
      "Swiss army knife for pentesting networks. Supports SMB, WinRM, SSH, MSSQL, LDAP.",
    inputSchema: {
      type: "object",
      properties: {
        instance_id: { type: "string", description: "Kali instance ID" },
        protocol: {
          type: "string",
          enum: ["smb", "winrm", "ssh", "mssql", "ldap"],
          description: "Protocol to use",
        },
        target: {
          type: "string",
          description: "Target IP, range, or CIDR",
        },
        username: { type: "string", description: "Username" },
        password: { type: "string", description: "Password" },
        hash: { type: "string", description: "NTLM hash" },
        domain: { type: "string", description: "Domain name" },
        module: {
          type: "string",
          description: "Module to run (e.g., 'mimikatz', 'lsassy')",
        },
        shares: { type: "boolean", description: "Enumerate shares (SMB)" },
        sam: { type: "boolean", description: "Dump SAM (SMB)" },
        lsa: { type: "boolean", description: "Dump LSA (SMB)" },
        sessions: {
          type: "boolean",
          description: "Enumerate sessions (SMB)",
        },
        exec_method: {
          type: "string",
          description: "Execution method (smbexec, wmiexec, atexec)",
        },
        command: {
          type: "string",
          description: "Command to execute",
        },
      },
      required: ["instance_id", "protocol", "target"],
    },
    handler: createToolRunner(
      backend,
      "instance_id",
      (args) => {
        const cmd = ["crackmapexec", args.protocol as string, args.target as string];

        if (args.username) cmd.push("-u", args.username as string);
        if (args.password) cmd.push("-p", args.password as string);
        if (args.hash) cmd.push("-H", args.hash as string);
        if (args.domain) cmd.push("-d", args.domain as string);
        if (args.module) cmd.push("-M", args.module as string);
        if (args.shares) cmd.push("--shares");
        if (args.sam) cmd.push("--sam");
        if (args.lsa) cmd.push("--lsa");
        if (args.sessions) cmd.push("--sessions");
        if (args.exec_method) cmd.push("--exec-method", args.exec_method as string);
        if (args.command) cmd.push("-x", args.command as string);

        return cmd;
      },
      900000
    ),
  });

  // bloodhound_collect - Active Directory enumeration
  tools.set("bloodhound_collect", {
    name: "bloodhound_collect",
    description: "Collect Active Directory data for BloodHound analysis.",
    inputSchema: {
      type: "object",
      properties: {
        instance_id: { type: "string", description: "Kali instance ID" },
        domain: { type: "string", description: "Target domain" },
        username: { type: "string", description: "Username" },
        password: { type: "string", description: "Password" },
        dc: { type: "string", description: "Domain controller IP/hostname" },
        collection_method: {
          type: "string",
          description: "Collection method (Default, All, DCOnly, etc.)",
        },
        output_dir: {
          type: "string",
          description: "Output directory for JSON files",
        },
      },
      required: ["instance_id", "domain", "username", "password"],
    },
    handler: createToolRunner(
      backend,
      "instance_id",
      (args) => {
        const cmd = [
          "bloodhound-python",
          "-d",
          args.domain as string,
          "-u",
          args.username as string,
          "-p",
          args.password as string,
        ];

        if (args.dc) cmd.push("-dc", args.dc as string);
        if (args.collection_method) cmd.push("-c", args.collection_method as string);
        if (args.output_dir) {
          cmd.push("--zip");
          cmd.push("-o", args.output_dir as string);
        }

        return cmd;
      },
      1800000
    ),
  });
}
